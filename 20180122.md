Level Test Upload


make test code

<pre>
<code>

 @BeforeEach
     public void before() {
         mockLoginComponent.mockLogin();
         levelTestsUploadPath = mockServiceComponent.createMockFileRepository(fileRepositoryService)
             .getPath();
     }

    @Test
    @Transactional
    public void testParse() throws Exception {
        readFile();
        parse();
        insert();


        LevelTestSet levelTestSet =
        levelTestSetService.selectLevelTestSetByLevelNSetNo(1,1);

        Assertions.assertEquals(7,levelTestSet.getTotalCnt());

        LevelTestQuestion levelTestQuestion = levelTestQuestionService.selectLevelTestQuestionByTestSet(levelTestSet.getId()).get(1);

        Assertions.assertEquals("1", levelTestQuestion.getAnswer());

    }


    public void readFile() throws Exception {
//        unzip file
        String uploadPath = FileUtil.getTempDir();
        File levelTestFile = ResourceUtils.getFile("classpath:test/test_lt101.zip");
        Assertions.assertTrue(levelTestFile.exists());

        ZipUtil.unzip(levelTestFile.toString(), uploadPath);

        String excelFilePath = Paths.get(uploadPath, "/lt101.xlsx").toString();
        levelTestExcelParser.readExcelFile(levelTestsUploadPath, excelFilePath);
    }

    public void parse() throws Exception {
        levelTestExcelParser.parse();
        for (LevelTestSet levelTestSet : levelTestExcelParser.getLevelTestsMap().values()) {
            levelTestExcelParser.copyResourceFiles(levelTestSet);
        }
    }

    public void insert() {
        Collection levelTests = levelTestExcelParser.getLevelTestsMap().values();
        Iterator iterator = levelTests.iterator();
        while (iterator.hasNext()) {
            LevelTestSet levelTestSet = (LevelTestSet) iterator.next();

            final LevelTestSet levelTestSetByLevelNSetNo = levelTestSetService
                .selectLevelTestSetByLevelNSetNo(levelTestSet.getLevelNo(),
                    levelTestSet.getSetNo());

            if (levelTestSetByLevelNSetNo == null) {
                levelTestSetService.insertLevelTestSet(levelTestSet);
                levelTestSetService.insertLevelTestQuestsionList(levelTestSet);
            } else {
                levelTestQuestionService.deleteQuestion(levelTestSetByLevelNSetNo.getId());
                levelTestSetService.updateLevelTestSet(levelTestSetByLevelNSetNo);
                levelTestSet.setId(levelTestSetByLevelNSetNo.getId());
                levelTestSetService.insertLevelTestQuestsionList(levelTestSet);
            }
        }

    }
</code>
</pre>
    
    
excel data parse
    
<pre>
<code>
    
    private Map<Integer/*levelTestSetNo*/, LevelTestSet> levelTestsMap;
    
    for (String sheetName : sheetNames) {
            try {
                final List<LevelTestQuestion> levelTestQuestionList = ExcelParseUtil
                    .parse(LevelTestQuestion.class, excelFilePath, sheetName, 3);

                LevelTestSet levelTestSet = LevelTestSet
                    .createLevelTestSet(levelTestQuestionList.get(0));
                levelTestSet.setTargetRootPath(targetRootPath);
                levelTestSet.setUploadRootPath(uploadRootPath);

                levelTestQuestionList.forEach(levelTestQuestion -> {
                    levelTestQuestion.init();

                    parseError.append(levelTestQuestion.validate(directionMap));
                    parseError.append(LevelTestValidator.validate(levelTestSet.getFileNamePrefix(),
                        uploadRootPath, levelTestQuestion));

                    levelTestSet.addLevelTestQuestion(levelTestQuestion);
                });

                levelTestsMap.put(levelTestSet.getSetNo(), levelTestSet);
            } catch (Exception e) {
                parseError.append(e.getMessage());
                LOGGER.debug(e.getMessage(), e);
            }
        }
            
</code>
</pre>
    
    
    
levelTestsMap 라고 만들었으나, 맵 자체를 사용안함, find usage 를 사용했을 때.. 굳이 set을 키로 해서 만들 필요가 없음 그래서 list 로 변환..
    
    
<pre>
<code>
    
    for (LevelTestSet levelTestSet : levelTestExcelParser.getLevelTestsMap().values()) {
            levelTestExcelParser.copyResourceFiles(levelTestSet);
        }
        
</code>
</pre>
   
<pre>
<code>
    
    for(LevelTestSet levelTestSet : levelTestExcelParser.getLevelTestSetList()) {
            levelTestExcelParser.copyResourceFiles(levelTestSet);
        }
        
</code>
</pre>


<pre>
<code>
    
    public void insert() {
        Collection levelTests = levelTestExcelParser.getLevelTestsMap().values();
        Iterator iterator = levelTests.iterator();
        while (iterator.hasNext()) {
            LevelTestSet levelTestSet = (LevelTestSet) iterator.next();

            final LevelTestSet levelTestSetByLevelNSetNo = levelTestSetService
                .selectLevelTestSetByLevelNSetNo(levelTestSet.getLevelNo(),
                    levelTestSet.getSetNo());

            if (levelTestSetByLevelNSetNo == null) {
                levelTestSetService.insertLevelTestSet(levelTestSet);
                levelTestSetService.insertLevelTestQuestsionList(levelTestSet);
            } else {
                levelTestQuestionService.deleteQuestion(levelTestSetByLevelNSetNo.getId());
                levelTestSetService.updateLevelTestSet(levelTestSetByLevelNSetNo);
                levelTestSet.setId(levelTestSetByLevelNSetNo.getId());
                levelTestSetService.insertLevelTestQuestsionList(levelTestSet);
            }
        }

    }
        
</code>
</pre>


<pre>
<code>

    public void insert() {

        for(LevelTestSet levelTestSet : levelTestExcelParser.getLevelTestSetList()) {

            final LevelTestSet levelTestSetByLevelNSetNo = levelTestSetService
                .selectLevelTestSetByLevelNSetNo(levelTestSet.getLevelNo(),
                    levelTestSet.getSetNo());

            if (levelTestSetByLevelNSetNo == null) {
                levelTestSetService.insertLevelTestSet(levelTestSet);
                levelTestSetService.insertLevelTestQuestsionList(levelTestSet);
            } else {
                levelTestQuestionService.deleteQuestion(levelTestSetByLevelNSetNo.getId());
                levelTestSetService.updateLevelTestSet(levelTestSetByLevelNSetNo);
                levelTestSet.setId(levelTestSetByLevelNSetNo.getId());
                levelTestSetService.insertLevelTestQuestsionList(levelTestSet);
            }
        }

    }

</code>
</pre>
